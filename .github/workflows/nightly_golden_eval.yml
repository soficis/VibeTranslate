name: Nightly Build Matrix

on:
  schedule:
    - cron: "0 2 * * *"
  workflow_dispatch:

env:
  DOTNET_CLI_TELEMETRY_OPTOUT: 1
  DOTNET_NOLOGO: 1
  PYTHONUTF8: "1"

jobs:
  windows-x64:
    name: Nightly Windows x64 build (all desktop apps)
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "9.0.x"

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: |
            TranslationFiestaElectron/package-lock.json
            TranslationFiestaGo/frontend/package-lock.json

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.23.x"

      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: "3.4"
          bundler-cache: true
          working-directory: TranslationFiestaRuby

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable

      - name: Build Windows app set
        shell: pwsh
        run: |
          $root = "$env:GITHUB_WORKSPACE\artifacts\nightly\windows-x64"
          New-Item -ItemType Directory -Force -Path $root | Out-Null

          # .NET apps
          dotnet publish TranslationFiestaCSharp/TranslationFiestaCSharp.csproj -c Release -r win-x64 --self-contained false -o "$root\TranslationFiestaCSharp"
          dotnet publish TranslationFiestaFSharp/TranslationFiestaFSharp.fsproj -c Release -r win-x64 --self-contained false -o "$root\TranslationFiestaFSharp"
          dotnet publish TranslationFiesta.WinUI/TranslationFiesta.WinUI.csproj -c Release -r win-x64 --self-contained false -p:WindowsPackageType=None -p:AppxPackage=false -p:GenerateAppxPackageOnBuild=false -o "$root\TranslationFiesta.WinUI"

          # Electron
          Push-Location TranslationFiestaElectron
          npm ci
          npm run build
          npx electron-packager . TranslationFiestaElectron --platform=win32 --arch=x64 --out "$root\TranslationFiestaElectron" --overwrite --prune=true
          Pop-Location

          # Flutter
          flutter config --enable-windows-desktop
          Push-Location TranslationFiestaFlutter
          flutter pub get
          flutter build windows --release
          Pop-Location
          New-Item -ItemType Directory -Force -Path "$root\TranslationFiestaFlutter" | Out-Null
          Copy-Item "$env:GITHUB_WORKSPACE\TranslationFiestaFlutter\build\windows\x64\runner\Release\*" "$root\TranslationFiestaFlutter" -Recurse -Force

          # Go/Wails
          go install github.com/wailsapp/wails/v2/cmd/wails@v2.10.2
          $env:PATH = "$env:PATH;$(go env GOPATH)\\bin"
          Push-Location TranslationFiestaGo
          wails build -platform windows/amd64 -clean -o TranslationFiestaGo.exe
          Pop-Location
          New-Item -ItemType Directory -Force -Path "$root\TranslationFiestaGo" | Out-Null
          Copy-Item "$env:GITHUB_WORKSPACE\TranslationFiestaGo\build\bin\TranslationFiestaGo.exe" "$root\TranslationFiestaGo\TranslationFiestaGo.exe" -Force

          # Python apps
          python -m pip install --upgrade pip
          pip install -r TranslationFiestaPy/requirements.txt
          pip install pyinstaller

          Push-Location TranslationFiestaPy
          pyinstaller --noconfirm --clean --windowed --onefile --name TranslationFiestaPy TranslationFiesta.py
          Pop-Location
          New-Item -ItemType Directory -Force -Path "$root\TranslationFiestaPy" | Out-Null
          Copy-Item "$env:GITHUB_WORKSPACE\TranslationFiestaPy\dist\TranslationFiestaPy.exe" "$root\TranslationFiestaPy\TranslationFiestaPy.exe" -Force

          pyinstaller --noconfirm --clean --onefile --name TranslationFiestaLocalService TranslationFiestaLocal/local_service.py
          New-Item -ItemType Directory -Force -Path "$root\TranslationFiestaLocal" | Out-Null
          Copy-Item "$env:GITHUB_WORKSPACE\dist\TranslationFiestaLocalService.exe" "$root\TranslationFiestaLocal\TranslationFiestaLocalService.exe" -Force

          # Ruby
          Push-Location TranslationFiestaRuby
          bundle install --jobs 4 --retry 3
          gem install ocra --no-document
          Set-Content -Path fiber.so -Value "" -NoNewline
          New-Item -ItemType Directory -Force -Path "$root\TranslationFiestaRuby" | Out-Null
          ocra --quiet bin\translation_fiesta --no-dep-run --gemfile Gemfile --gem-full --add-all-core --windows --chdir-first --output "$root\TranslationFiestaRuby\TranslationFiestaRuby.exe" config\config.yml lib\translation_fiesta\web\views\index.erb lib\translation_fiesta\web\views\layout.erb
          Remove-Item fiber.so -Force
          Pop-Location

      - name: Verify nightly Windows executables
        shell: pwsh
        run: |
          $expected = @(
            "artifacts\nightly\windows-x64\TranslationFiestaCSharp\TranslationFiestaCSharp.exe",
            "artifacts\nightly\windows-x64\TranslationFiestaFSharp\TranslationFiestaFSharp.exe",
            "artifacts\nightly\windows-x64\TranslationFiesta.WinUI\TranslationFiesta.WinUI.exe",
            "artifacts\nightly\windows-x64\TranslationFiestaElectron\TranslationFiestaElectron-win32-x64\TranslationFiestaElectron.exe",
            "artifacts\nightly\windows-x64\TranslationFiestaFlutter\TranslationFiestaFlutter.exe",
            "artifacts\nightly\windows-x64\TranslationFiestaGo\TranslationFiestaGo.exe",
            "artifacts\nightly\windows-x64\TranslationFiestaPy\TranslationFiestaPy.exe",
            "artifacts\nightly\windows-x64\TranslationFiestaRuby\TranslationFiestaRuby.exe",
            "artifacts\nightly\windows-x64\TranslationFiestaLocal\TranslationFiestaLocalService.exe"
          )

          foreach ($relative in $expected) {
            $full = Join-Path $env:GITHUB_WORKSPACE $relative
            if (!(Test-Path $full)) {
              throw "Missing expected nightly artifact: $relative"
            }
          }

      - name: Upload nightly Windows artifacts
        uses: actions/upload-artifact@v4
        with:
          name: nightly-windows-x64
          path: artifacts/nightly/windows-x64/**
          if-no-files-found: error

  swift-macos:
    name: Nightly macOS Swift build
    runs-on: macos-14

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Build and test TranslationFiestaSwift
        run: |
          cd TranslationFiestaSwift
          swift build -c release
          swift test --parallel

      - name: Collect Swift artifact
        run: |
          set -euo pipefail
          out="artifacts/nightly/macos-swift"
          mkdir -p "$out"
          cp "TranslationFiestaSwift/.build/release/TranslationFiestaSwift" "$out/TranslationFiestaSwift"
          shasum -a 256 "$out/TranslationFiestaSwift" > "$out/TranslationFiestaSwift.sha256"

      - name: Upload nightly Swift artifacts
        uses: actions/upload-artifact@v4
        with:
          name: nightly-macos-swift
          path: artifacts/nightly/macos-swift/*
          if-no-files-found: error
