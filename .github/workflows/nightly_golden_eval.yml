name: Nightly Build Matrix

on:
  schedule:
    - cron: "0 2 * * *"
  workflow_dispatch:

env:
  DOTNET_CLI_TELEMETRY_OPTOUT: 1
  DOTNET_NOLOGO: 1
  PYTHONUTF8: "1"

jobs:
  windows-matrix:
    name: Nightly Windows ${{ matrix.arch }}
    runs-on: ${{ matrix.runner }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - arch: x64
            runner: windows-latest
            rid: win-x64
            dotnet_platform: x64
            go_platform: windows/amd64
            electron_arch: x64
          - arch: arm64
            runner: windows-11-arm
            rid: win-arm64
            dotnet_platform: arm64
            go_platform: windows/arm64
            electron_arch: arm64

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup .NET
        uses: actions/setup-dotnet@v5
        with:
          dotnet-version: "10.0.x"

      - name: Setup Python
        uses: actions/setup-python@v6
        with:
          python-version: "3.13"

      - name: Setup Node
        uses: actions/setup-node@v6
        with:
          node-version: "24"
          cache: npm
          cache-dependency-path: |
            TranslationFiestaElectron/package-lock.json
            TranslationFiestaGo/frontend/package-lock.json

      - name: Setup Go
        uses: actions/setup-go@v6
        with:
          go-version: "1.26.x"
          cache-dependency-path: TranslationFiestaGo/go.sum

      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: "3.4"
          bundler-cache: false
          working-directory: TranslationFiestaRuby

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable

      - name: Build nightly Windows app set
        shell: pwsh
        run: |
          $root = "$env:GITHUB_WORKSPACE\artifacts\nightly\windows-${{ matrix.arch }}"
          New-Item -ItemType Directory -Force -Path $root | Out-Null

          dotnet publish TranslationFiestaCSharp/TranslationFiestaCSharp.csproj -c Release -r ${{ matrix.rid }} --self-contained true -o "$root\TranslationFiestaCSharp"
          dotnet publish TranslationFiestaFSharp/TranslationFiestaFSharp.fsproj -c Release -r ${{ matrix.rid }} --self-contained true -o "$root\TranslationFiestaFSharp"
          dotnet publish TranslationFiesta.WinUI/TranslationFiesta.WinUI.csproj -c Release -r ${{ matrix.rid }} --self-contained true -p:Platform=${{ matrix.dotnet_platform }} -p:RuntimeIdentifier=${{ matrix.rid }} -p:WindowsAppSDKSelfContained=true -p:WindowsPackageType=None -p:AppxPackage=false -p:GenerateAppxPackageOnBuild=false -o "$root\TranslationFiesta.WinUI"

          Push-Location TranslationFiestaElectron
          npm ci
          npm run build
          npx electron-packager . TranslationFiestaElectron --platform=win32 --arch=${{ matrix.electron_arch }} --out "$root\TranslationFiestaElectron" --overwrite --prune=true
          Pop-Location

          flutter config --enable-windows-desktop
          Push-Location TranslationFiestaFlutter
          flutter pub get
          flutter build windows --release
          Pop-Location

          New-Item -ItemType Directory -Force -Path "$root\TranslationFiestaFlutter" | Out-Null
          $flutterSource = "$env:GITHUB_WORKSPACE\TranslationFiestaFlutter\build\windows\${{ matrix.arch }}\runner\Release"
          if (!(Test-Path $flutterSource)) {
            $flutterSource = Get-ChildItem "$env:GITHUB_WORKSPACE\TranslationFiestaFlutter\build\windows" -Directory |
              ForEach-Object { Join-Path $_.FullName 'runner\\Release' } |
              Where-Object { Test-Path $_ } |
              Select-Object -First 1
          }
          Copy-Item "$flutterSource\*" "$root\TranslationFiestaFlutter" -Recurse -Force

          go install github.com/wailsapp/wails/v2/cmd/wails@v2.11.0
          $env:PATH = "$env:PATH;$(go env GOPATH)\\bin"
          Push-Location TranslationFiestaGo
          wails build -platform ${{ matrix.go_platform }} -clean -o TranslationFiestaGo
          Pop-Location
          New-Item -ItemType Directory -Force -Path "$root\TranslationFiestaGo" | Out-Null
          $goBinary = "$env:GITHUB_WORKSPACE\TranslationFiestaGo\build\bin\TranslationFiestaGo.exe"
          if (!(Test-Path $goBinary)) {
            $goBinary = "$env:GITHUB_WORKSPACE\TranslationFiestaGo\build\bin\TranslationFiestaGo"
          }
          if (!(Test-Path $goBinary)) {
            $goBinary = Get-ChildItem "$env:GITHUB_WORKSPACE\TranslationFiestaGo\build\bin" -File |
              Where-Object { $_.Name -like 'TranslationFiestaGo*' } |
              Select-Object -First 1 -ExpandProperty FullName
          }
          Copy-Item $goBinary "$root\TranslationFiestaGo\TranslationFiestaGo.exe" -Force

          python -m pip install --upgrade pip
          pip install -r TranslationFiestaPy/requirements.lock
          pip install pyinstaller

          Push-Location TranslationFiestaPy
          pyinstaller --noconfirm --clean --windowed --onefile --name TranslationFiestaPy TranslationFiesta.py
          Pop-Location
          New-Item -ItemType Directory -Force -Path "$root\TranslationFiestaPy" | Out-Null
          Copy-Item "$env:GITHUB_WORKSPACE\TranslationFiestaPy\dist\TranslationFiestaPy.exe" "$root\TranslationFiestaPy\TranslationFiestaPy.exe" -Force


          $rubyTarget = "$root\TranslationFiestaRuby"
          New-Item -ItemType Directory -Force -Path $rubyTarget | Out-Null

          Push-Location TranslationFiestaRuby
          gem install rake --no-document
          bundle install --deployment --path vendor/bundle --jobs 4 --retry 3
          $rubyPrefix = (& ruby -e "require 'rbconfig'; print RbConfig::CONFIG['prefix']").Trim()
          Pop-Location

          $sourceRoot = "$env:GITHUB_WORKSPACE\TranslationFiestaRuby"
          $pathsToCopy = @('Gemfile', 'Gemfile.lock', 'translation_fiesta.gemspec', 'bin', 'lib', 'config', 'vendor')
          foreach ($path in $pathsToCopy) {
            Copy-Item (Join-Path $sourceRoot $path) (Join-Path $rubyTarget $path) -Recurse -Force
          }

          $rubyPrefixPath = $rubyPrefix -replace '/', '\'
          if (!(Test-Path $rubyPrefixPath)) {
            throw "Ruby runtime path not found: $rubyPrefixPath"
          }

          $rubyRuntimeTarget = Join-Path $rubyTarget 'ruby-runtime'
          New-Item -ItemType Directory -Force -Path $rubyRuntimeTarget | Out-Null
          Copy-Item (Join-Path $rubyPrefixPath '*') $rubyRuntimeTarget -Recurse -Force

          $bundleBat = Join-Path $rubyRuntimeTarget 'bin\bundle.bat'
          if (!(Test-Path $bundleBat)) {
            throw "Bundled Ruby runtime is missing bundle.bat at $bundleBat"
          }

          $libGmp = Get-ChildItem -Path $rubyRuntimeTarget -Recurse -Filter 'libgmp-10.dll' | Select-Object -First 1
          if (-not $libGmp) {
            throw "Bundled Ruby runtime is missing libgmp-10.dll"
          }

          $runPs1 = @(
            "Set-StrictMode -Version Latest"
            "`$ErrorActionPreference = 'Stop'"
            "Set-Location `$PSScriptRoot"
            "`$runtimeBin = Join-Path `$PSScriptRoot 'ruby-runtime\bin'"
            "`$env:PATH = ""`$runtimeBin;`$env:PATH"""
            "`$env:BUNDLE_GEMFILE = Join-Path `$PSScriptRoot 'Gemfile'"
            "`$env:BUNDLE_PATH = Join-Path `$PSScriptRoot 'vendor\bundle'"
            "& (Join-Path `$runtimeBin 'bundle.bat') exec ruby bin/translation_fiesta"
          ) -join [Environment]::NewLine
          Set-Content -Path "$rubyTarget\run.ps1" -Value $runPs1

          $runCmd = @(
            "@echo off"
            "setlocal"
            "cd /d ""%~dp0"""
            "set ""RUNTIME_BIN=%~dp0ruby-runtime\bin"""
            "set ""PATH=%RUNTIME_BIN%;%PATH%"""
            "set ""BUNDLE_GEMFILE=%~dp0Gemfile"""
            "set ""BUNDLE_PATH=%~dp0vendor\bundle"""
            "call ""%RUNTIME_BIN%\bundle.bat"" exec ruby bin\translation_fiesta"
          ) -join [Environment]::NewLine
          Set-Content -Path "$rubyTarget\run.cmd" -Value $runCmd

      - name: Package nightly Windows artifacts
        shell: pwsh
        run: |
          $sourceRoot = "$env:GITHUB_WORKSPACE\artifacts\nightly\windows-${{ matrix.arch }}"
          $zipRoot = "$env:GITHUB_WORKSPACE\artifacts\nightly\windows-${{ matrix.arch }}-zips"
          New-Item -ItemType Directory -Force -Path $zipRoot | Out-Null

          Get-ChildItem -Path $sourceRoot -Directory | Sort-Object Name | ForEach-Object {
            $appName = $_.Name
            $zipName = "$appName-windows-${{ matrix.arch }}.zip"
            $zipPath = Join-Path $zipRoot $zipName
            if (Test-Path $zipPath) { Remove-Item $zipPath -Force }

            Compress-Archive -Path (Join-Path $_.FullName '*') -DestinationPath $zipPath -CompressionLevel Optimal
            $hash = (Get-FileHash -Path $zipPath -Algorithm SHA256).Hash.ToLower()
            "$hash  $zipName" | Set-Content "$zipPath.sha256"
          }

          Get-ChildItem -Path $zipRoot -Filter '*.sha256' | Sort-Object Name | Get-Content | Set-Content (Join-Path $zipRoot 'SHA256SUMS-windows-${{ matrix.arch }}.txt')

      - name: Upload nightly Windows artifacts
        uses: actions/upload-artifact@v6
        with:
          name: nightly-windows-${{ matrix.arch }}
          path: artifacts/nightly/windows-${{ matrix.arch }}-zips/*
          if-no-files-found: error

  linux-matrix:
    name: Nightly Linux ${{ matrix.arch }}
    runs-on: ${{ matrix.runner }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - arch: x64
            runner: ubuntu-24.04
            go_platform: linux/amd64
            electron_arch: x64
          - arch: arm64
            runner: ubuntu-24.04-arm
            go_platform: linux/arm64
            electron_arch: arm64

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Python
        uses: actions/setup-python@v6
        with:
          python-version: "3.13"

      - name: Setup Node
        uses: actions/setup-node@v6
        with:
          node-version: "24"
          cache: npm
          cache-dependency-path: |
            TranslationFiestaElectron/package-lock.json
            TranslationFiestaGo/frontend/package-lock.json

      - name: Setup Go
        uses: actions/setup-go@v6
        with:
          go-version: "1.26.x"
          cache-dependency-path: TranslationFiestaGo/go.sum

      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: "3.4"
          bundler-cache: false
          working-directory: TranslationFiestaRuby

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable

      - name: Install Linux desktop build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            clang \
            cmake \
            ninja-build \
            pkg-config \
            zip \
            libgtk-3-dev \
            liblzma-dev \
            libwebkit2gtk-4.1-dev \
            libsoup-3.0-dev

      - name: Build nightly Linux app set
        run: |
          set -euo pipefail
          root="$GITHUB_WORKSPACE/artifacts/nightly/linux-${{ matrix.arch }}"
          mkdir -p "$root"

          cd TranslationFiestaElectron
          npm ci
          npm run build
          npx electron-packager . TranslationFiestaElectron --platform=linux --arch=${{ matrix.electron_arch }} --out "$root/TranslationFiestaElectron" --overwrite --prune=true

          cd "$GITHUB_WORKSPACE"
          flutter config --enable-linux-desktop
          cd TranslationFiestaFlutter
          flutter pub get
          flutter build linux --release
          mkdir -p "$root/TranslationFiestaFlutter"
          flutter_bundle="$(find "$GITHUB_WORKSPACE/TranslationFiestaFlutter/build/linux" -type d -path '*/release/bundle' | head -n1)"
          cp -R "$flutter_bundle"/* "$root/TranslationFiestaFlutter/"

          cd "$GITHUB_WORKSPACE"
          go install github.com/wailsapp/wails/v2/cmd/wails@v2.11.0
          export PATH="$PATH:$(go env GOPATH)/bin"
          cd TranslationFiestaGo
          wails build -platform "${{ matrix.go_platform }}" -tags webkit2_41 -clean -o TranslationFiestaGo
          mkdir -p "$root/TranslationFiestaGo"
          go_binary="$(find "$GITHUB_WORKSPACE/TranslationFiestaGo/build/bin" -maxdepth 1 -type f -name 'TranslationFiestaGo*' | head -n1)"
          cp "$go_binary" "$root/TranslationFiestaGo/TranslationFiestaGo"

          cd "$GITHUB_WORKSPACE"
          python -m pip install --upgrade pip
          pip install -r TranslationFiestaPy/requirements.lock
          pip install pyinstaller

          cd TranslationFiestaPy
          pyinstaller --noconfirm --clean --onefile --name TranslationFiestaPy TranslationFiesta.py
          mkdir -p "$root/TranslationFiestaPy"
          cp "$GITHUB_WORKSPACE/TranslationFiestaPy/dist/TranslationFiestaPy" "$root/TranslationFiestaPy/TranslationFiestaPy"


          cd "$GITHUB_WORKSPACE/TranslationFiestaRuby"
          gem install rake --no-document
          bundle install --jobs 4 --retry 3
          mkdir -p "$root/TranslationFiestaRuby"
          cp -R Gemfile Gemfile.lock translation_fiesta.gemspec bin lib config "$root/TranslationFiestaRuby/"
          printf '%s\n' \
            '#!/usr/bin/env bash' \
            'set -euo pipefail' \
            'cd "$(dirname "$0")"' \
            'bundle install' \
            'bundle exec ruby bin/translation_fiesta' > "$root/TranslationFiestaRuby/run.sh"
          chmod +x "$root/TranslationFiestaRuby/run.sh"

      - name: Package nightly Linux artifacts
        run: |
          set -euo pipefail
          source_root="$GITHUB_WORKSPACE/artifacts/nightly/linux-${{ matrix.arch }}"
          zip_root="$GITHUB_WORKSPACE/artifacts/nightly/linux-${{ matrix.arch }}-zips"
          mkdir -p "$zip_root"

          for app_dir in "$source_root"/*; do
            [[ -d "$app_dir" ]] || continue
            app_name="$(basename "$app_dir")"
            zip_name="${app_name}-linux-${{ matrix.arch }}.zip"
            zip_path="$zip_root/$zip_name"

            rm -f "$zip_path"
            (
              cd "$source_root"
              zip -r "$zip_path" "$app_name" >/dev/null
            )
            hash="$(sha256sum "$zip_path" | cut -d' ' -f1)"
            echo "$hash  $zip_name" > "$zip_path.sha256"
          done

          cat "$zip_root"/*.sha256 | sort > "$zip_root/SHA256SUMS-linux-${{ matrix.arch }}.txt"

      - name: Upload nightly Linux artifacts
        uses: actions/upload-artifact@v6
        with:
          name: nightly-linux-${{ matrix.arch }}
          path: artifacts/nightly/linux-${{ matrix.arch }}-zips/*
          if-no-files-found: error

  macos-matrix:
    name: Nightly macOS ${{ matrix.arch }}
    runs-on: ${{ matrix.runner }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - arch: x64
            runner: macos-15-intel
            go_platform: darwin/amd64
            electron_arch: x64
          - arch: arm64
            runner: macos-15
            go_platform: darwin/arm64
            electron_arch: arm64

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Python
        uses: actions/setup-python@v6
        with:
          python-version: "3.13"

      - name: Setup Node
        uses: actions/setup-node@v6
        with:
          node-version: "24"
          cache: npm
          cache-dependency-path: |
            TranslationFiestaElectron/package-lock.json
            TranslationFiestaGo/frontend/package-lock.json

      - name: Setup Go
        uses: actions/setup-go@v6
        with:
          go-version: "1.26.x"
          cache-dependency-path: TranslationFiestaGo/go.sum

      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: "3.4"
          bundler-cache: false
          working-directory: TranslationFiestaRuby

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable

      - name: Build nightly macOS app set
        run: |
          set -euo pipefail
          root="$GITHUB_WORKSPACE/artifacts/nightly/macos-${{ matrix.arch }}"
          mkdir -p "$root"

          cd TranslationFiestaSwift
          swift build -c release
          mkdir -p "$root/TranslationFiestaSwift"
          cp "$GITHUB_WORKSPACE/TranslationFiestaSwift/.build/release/TranslationFiestaSwift" "$root/TranslationFiestaSwift/TranslationFiestaSwift"

          cd "$GITHUB_WORKSPACE/TranslationFiestaElectron"
          npm ci
          npm run build
          npx electron-packager . TranslationFiestaElectron --platform=darwin --arch=${{ matrix.electron_arch }} --out "$root/TranslationFiestaElectron" --overwrite --prune=true

          cd "$GITHUB_WORKSPACE"
          flutter config --enable-macos-desktop
          cd TranslationFiestaFlutter
          flutter pub get
          flutter build macos --release
          mkdir -p "$root/TranslationFiestaFlutter"
          flutter_app="$(find "$GITHUB_WORKSPACE/TranslationFiestaFlutter/build/macos/Build/Products/Release" -maxdepth 1 -type d -name '*.app' | head -n1)"
          cp -R "$flutter_app" "$root/TranslationFiestaFlutter/"

          cd "$GITHUB_WORKSPACE"
          go install github.com/wailsapp/wails/v2/cmd/wails@v2.11.0
          export PATH="$PATH:$(go env GOPATH)/bin"
          cd TranslationFiestaGo
          wails build -platform "${{ matrix.go_platform }}" -clean -o TranslationFiestaGo
          mkdir -p "$root/TranslationFiestaGo"
          if [[ -d "$GITHUB_WORKSPACE/TranslationFiestaGo/build/bin/TranslationFiestaGo.app" ]]; then
            cp -R "$GITHUB_WORKSPACE/TranslationFiestaGo/build/bin/TranslationFiestaGo.app" "$root/TranslationFiestaGo/"
          fi
          go_binary="$(find "$GITHUB_WORKSPACE/TranslationFiestaGo/build/bin" -maxdepth 1 -type f -name 'TranslationFiestaGo*' | head -n1)"
          if [[ -n "$go_binary" ]]; then
            cp "$go_binary" "$root/TranslationFiestaGo/TranslationFiestaGo"
          fi

          cd "$GITHUB_WORKSPACE"
          python -m pip install --upgrade pip
          pip install -r TranslationFiestaPy/requirements.lock
          pip install pyinstaller

          cd TranslationFiestaPy
          pyinstaller --noconfirm --clean --onefile --name TranslationFiestaPy TranslationFiesta.py
          mkdir -p "$root/TranslationFiestaPy"
          cp "$GITHUB_WORKSPACE/TranslationFiestaPy/dist/TranslationFiestaPy" "$root/TranslationFiestaPy/TranslationFiestaPy"


          cd "$GITHUB_WORKSPACE/TranslationFiestaRuby"
          gem install rake --no-document
          bundle install --jobs 4 --retry 3
          mkdir -p "$root/TranslationFiestaRuby"
          cp -R Gemfile Gemfile.lock translation_fiesta.gemspec bin lib config "$root/TranslationFiestaRuby/"
          printf '%s\n' \
            '#!/usr/bin/env bash' \
            'set -euo pipefail' \
            'cd "$(dirname "$0")"' \
            'bundle install' \
            'bundle exec ruby bin/translation_fiesta' > "$root/TranslationFiestaRuby/run.command"
          chmod +x "$root/TranslationFiestaRuby/run.command"

      - name: Package nightly macOS artifacts
        run: |
          set -euo pipefail
          source_root="$GITHUB_WORKSPACE/artifacts/nightly/macos-${{ matrix.arch }}"
          zip_root="$GITHUB_WORKSPACE/artifacts/nightly/macos-${{ matrix.arch }}-zips"
          mkdir -p "$zip_root"

          for app_dir in "$source_root"/*; do
            [[ -d "$app_dir" ]] || continue
            app_name="$(basename "$app_dir")"
            zip_path="$zip_root/${app_name}-macos-${{ matrix.arch }}.zip"

            rm -f "$zip_path"
            ditto -c -k --sequesterRsrc --keepParent "$app_dir" "$zip_path"
            zip_name="$(basename "$zip_path")"
            hash="$(shasum -a 256 "$zip_path" | cut -d' ' -f1)"
            echo "$hash  $zip_name" > "$zip_path.sha256"
          done

          cat "$zip_root"/*.sha256 | sort > "$zip_root/SHA256SUMS-macos-${{ matrix.arch }}.txt"

      - name: Upload nightly macOS artifacts
        uses: actions/upload-artifact@v6
        with:
          name: nightly-macos-${{ matrix.arch }}
          path: artifacts/nightly/macos-${{ matrix.arch }}-zips/*
          if-no-files-found: error
