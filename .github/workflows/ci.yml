name: CI

on:
  push:
    branches: ["main"]
  pull_request:
  workflow_dispatch:

env:
  DOTNET_CLI_TELEMETRY_OPTOUT: 1
  DOTNET_NOLOGO: 1
  PYTHONUTF8: "1"

jobs:
  python:
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v6

      - uses: actions/setup-python@v6
        with:
          python-version: "3.13"

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r TranslationFiestaPy/requirements.lock
          pip install ruff pytest

      - name: Lint and compile Python
        run: |
          ruff check TranslationFiestaPy
          python -m compileall -q TranslationFiestaPy

      - name: Run Python tests
        run: |
          cd TranslationFiestaPy
          pytest -q -s test_unofficial_provider.py test_theme.py

  go:
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v6

      - uses: actions/setup-go@v6
        with:
          go-version: "1.26.x"
          cache-dependency-path: TranslationFiestaGo/go.sum

      - uses: actions/setup-node@v6
        with:
          node-version: "24"
          cache: npm
          cache-dependency-path: TranslationFiestaGo/frontend/package-lock.json

      - name: Build Go frontend assets
        run: |
          cd TranslationFiestaGo/frontend
          npm ci
          npm run build

      - name: Vet and test Go domain code
        run: |
          cd TranslationFiestaGo
          go vet ./internal/... ./test/...
          go test ./internal/... ./test/...

  electron:
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v6

      - uses: actions/setup-node@v6
        with:
          node-version: "24"
          cache: npm
          cache-dependency-path: TranslationFiestaElectron/package-lock.json

      - name: Build and test Electron
        run: |
          cd TranslationFiestaElectron
          npm ci
          npx tsc --noEmit
          npm run build
          npm test

  flutter:
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v6

      - name: Install Linux desktop build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y clang cmake ninja-build pkg-config libgtk-3-dev liblzma-dev

      - uses: subosito/flutter-action@v2
        with:
          channel: stable

      - name: Analyze, test, and build Flutter
        run: |
          flutter config --enable-linux-desktop
          cd TranslationFiestaFlutter
          flutter pub get
          flutter analyze
          flutter test
          flutter build linux --release

  dotnet-windows:
    name: .NET Windows publish (${{ matrix.arch }})
    runs-on: ${{ matrix.runner }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - arch: x64
            runner: windows-latest
            rid: win-x64
            platform: x64
          - arch: arm64
            runner: windows-11-arm
            rid: win-arm64
            platform: arm64

    steps:
      - uses: actions/checkout@v6

      - uses: actions/setup-dotnet@v5
        with:
          dotnet-version: "10.0.x"

      - name: Publish .NET desktop applications
        shell: pwsh
        run: |
          $out = "$env:RUNNER_TEMP\ci-dotnet-${{ matrix.arch }}"
          New-Item -ItemType Directory -Force -Path $out | Out-Null

          dotnet publish TranslationFiestaCSharp/TranslationFiestaCSharp.csproj -c Release -r ${{ matrix.rid }} --self-contained true -o "$out\TranslationFiestaCSharp"
          dotnet publish TranslationFiestaFSharp/TranslationFiestaFSharp.fsproj -c Release -r ${{ matrix.rid }} --self-contained true -o "$out\TranslationFiestaFSharp"
          dotnet publish TranslationFiesta.WinUI/TranslationFiesta.WinUI.csproj -c Release -r ${{ matrix.rid }} --self-contained true -p:Platform=${{ matrix.platform }} -p:RuntimeIdentifier=${{ matrix.rid }} -p:WindowsAppSDKSelfContained=true -p:WindowsPackageType=None -p:AppxPackage=false -p:GenerateAppxPackageOnBuild=false -o "$out\TranslationFiesta.WinUI"

          $expected = @(
            "$out\TranslationFiestaCSharp\TranslationFiestaCSharp.exe",
            "$out\TranslationFiestaFSharp\TranslationFiestaFSharp.exe",
            "$out\TranslationFiesta.WinUI\TranslationFiesta.WinUI.exe"
          )

          foreach ($file in $expected) {
            if (!(Test-Path $file)) {
              throw "Missing expected build output: $file"
            }
          }

  arm64-cross-platform-smoke:
    name: ARM64 smoke (${{ matrix.target }})
    runs-on: ${{ matrix.runner }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - target: windows
            runner: windows-11-arm
            electron_platform: win32
            go_platform: windows/arm64
            flutter_target: windows
          - target: linux
            runner: ubuntu-24.04-arm
            electron_platform: linux
            go_platform: linux/arm64
            flutter_target: linux
          - target: macos
            runner: macos-15
            electron_platform: darwin
            go_platform: darwin/arm64
            flutter_target: macos

    steps:
      - uses: actions/checkout@v6

      - uses: actions/setup-python@v6
        with:
          python-version: "3.13"

      - uses: actions/setup-node@v6
        with:
          node-version: "24"
          cache: npm
          cache-dependency-path: |
            TranslationFiestaElectron/package-lock.json
            TranslationFiestaGo/frontend/package-lock.json

      - uses: actions/setup-go@v6
        with:
          go-version: "1.26.x"
          cache-dependency-path: TranslationFiestaGo/go.sum

      - uses: ruby/setup-ruby@v1
        with:
          ruby-version: "3.4"
          bundler-cache: false
          working-directory: TranslationFiestaRuby

      - uses: subosito/flutter-action@v2
        with:
          channel: stable

      - name: Install Linux build dependencies
        if: matrix.target == 'linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            clang \
            cmake \
            ninja-build \
            pkg-config \
            libgtk-3-dev \
            liblzma-dev \
            libwebkit2gtk-4.1-dev \
            libsoup-3.0-dev

      - name: Electron ARM64 smoke build
        if: matrix.target == 'windows'
        shell: pwsh
        run: |
          cd TranslationFiestaElectron
          npm ci
          npm run build
          npx electron-packager . TranslationFiestaElectron --platform=win32 --arch=arm64 --out ..\dist\ci-smoke\electron --overwrite --prune=true

      - name: Electron ARM64 smoke build (non-Windows)
        if: matrix.target != 'windows'
        shell: bash
        run: |
          cd TranslationFiestaElectron
          npm ci
          npm run build
          npx electron-packager . TranslationFiestaElectron --platform=${{ matrix.electron_platform }} --arch=arm64 --out ../dist/ci-smoke/electron --overwrite --prune=true

      - name: Go ARM64 smoke build
        if: matrix.target == 'windows'
        shell: pwsh
        run: |
          cd TranslationFiestaGo/frontend
          npm ci
          npm run build
          cd ..
          go test ./internal/... ./test/...

      - name: Go ARM64 smoke build (non-Windows)
        if: matrix.target != 'windows'
        shell: bash
        run: |
          cd TranslationFiestaGo/frontend
          npm ci
          npm run build
          cd ..
          go test ./internal/... ./test/...

      - name: Wails ARM64 smoke package
        if: matrix.target == 'windows'
        shell: pwsh
        run: |
          cd TranslationFiestaGo
          go run github.com/wailsapp/wails/v2/cmd/wails@v2.11.0 build -platform "${{ matrix.go_platform }}" -clean -o TranslationFiestaGo

      - name: Wails ARM64 smoke package (non-Windows)
        if: matrix.target != 'windows'
        shell: bash
        run: |
          cd TranslationFiestaGo
          if [ "${{ matrix.target }}" = "linux" ]; then
            go run github.com/wailsapp/wails/v2/cmd/wails@v2.11.0 build -platform "${{ matrix.go_platform }}" -tags webkit2_41 -clean -o TranslationFiestaGo
          else
            go run github.com/wailsapp/wails/v2/cmd/wails@v2.11.0 build -platform "${{ matrix.go_platform }}" -clean -o TranslationFiestaGo
          fi

      - name: Python ARM64 smoke build
        if: matrix.target == 'windows'
        shell: pwsh
        run: |
          python -m pip install --upgrade pip
          pip install -r TranslationFiestaPy/requirements.lock
          pip install pyinstaller

          cd TranslationFiestaPy
          pyinstaller --noconfirm --clean --onefile --name TranslationFiestaPy TranslationFiesta.py

      - name: Python ARM64 smoke build (non-Windows)
        if: matrix.target != 'windows'
        shell: bash
        run: |
          python -m pip install --upgrade pip
          pip install -r TranslationFiestaPy/requirements.lock
          pip install pyinstaller

          cd TranslationFiestaPy
          pyinstaller --noconfirm --clean --onefile --name TranslationFiestaPy TranslationFiesta.py

      - name: Flutter ARM64 smoke build
        if: matrix.target == 'windows'
        shell: pwsh
        run: |
          flutter config --enable-windows-desktop
          cd TranslationFiestaFlutter
          flutter pub get
          flutter build windows --release

      - name: Flutter ARM64 smoke build (non-Windows)
        if: matrix.target != 'windows'
        shell: bash
        run: |
          if [ "${{ matrix.flutter_target }}" = "linux" ]; then
            flutter config --enable-linux-desktop
            cd TranslationFiestaFlutter
            flutter pub get
            flutter build linux --release
          else
            flutter config --enable-macos-desktop
            cd TranslationFiestaFlutter
            flutter pub get
            flutter build macos --release
          fi

      - name: Ruby ARM64 smoke build
        if: matrix.target == 'windows'
        shell: pwsh
        run: |
          cd TranslationFiestaRuby
          gem install rake --no-document
          bundle install --jobs 4 --retry 3
          ruby -c bin/translation_fiesta

      - name: Ruby ARM64 smoke build (non-Windows)
        if: matrix.target != 'windows'
        shell: bash
        run: |
          cd TranslationFiestaRuby
          gem install rake --no-document
          bundle install --jobs 4 --retry 3
          bundle exec ruby -c bin/translation_fiesta

      - name: Swift ARM64 smoke build
        if: matrix.target == 'macos'
        shell: bash
        run: |
          cd TranslationFiestaSwift
          swift build -c release
          swift test --parallel

  swift:
    runs-on: macos-15-intel
    steps:
      - uses: actions/checkout@v6

      - name: Build and test Swift package
        run: |
          cd TranslationFiestaSwift
          swift build -c release
          swift test --parallel

  ruby:
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v6

      - uses: ruby/setup-ruby@v1
        with:
          ruby-version: "3.4"
          bundler-cache: false
          working-directory: TranslationFiestaRuby

      - name: Install Ruby dependencies
        run: |
          cd TranslationFiestaRuby
          gem install rake --no-document
          bundle install --jobs 4 --retry 3

      - name: Lint and test Ruby
        run: |
          cd TranslationFiestaRuby
          bundle exec rubocop --fail-level E
          bundle exec rspec

  repo-hygiene:
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v6

      - name: Reject tracked bytecode artifacts
        run: |
          if git ls-files '*.pyc' | grep -q .; then
            echo 'Tracked *.pyc files found';
            git ls-files '*.pyc';
            exit 1;
          fi

      - name: Reject disabled source files
        run: |
          if git ls-files '*.disabled' | grep -q .; then
            echo 'Tracked *.disabled files found';
            git ls-files '*.disabled';
            exit 1;
          fi

      - name: Reject Python exception swallowing
        run: |
          if grep -RIn --include='*.py' 'except:[[:space:]]*pass' TranslationFiestaPy; then
            echo 'Found except: pass in Python sources';
            exit 1;
          fi

      - name: Reject bare catch blocks in C#
        run: |
          if grep -RIn --include='*.cs' --exclude-dir=obj 'catch[[:space:]]*{' TranslationFiestaCSharp TranslationFiesta.WinUI; then
            echo 'Found bare catch block in C# sources';
            exit 1;
          fi

      - name: Reject legacy compatibility wrapper text
        run: |
          if grep -RIni --include='*.py' --include='*.cs' --include='*.fs' --include='*.go' --include='*.rb' --include='*.swift' 'legacy function for backward' TranslationFiestaPy TranslationFiestaCSharp TranslationFiestaFSharp TranslationFiestaGo TranslationFiestaRuby TranslationFiestaSwift TranslationFiesta.WinUI; then
            echo 'Found legacy compatibility wrappers in source files';
            exit 1;
          fi
