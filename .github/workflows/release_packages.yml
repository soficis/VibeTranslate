name: Release Packages

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      release_tag:
        description: "Tag name to publish (for example: v0.4.1)"
        required: true
        type: string
      release_name:
        description: Optional release title override
        required: false
        default: ""
        type: string
      prerelease:
        description: Mark the release as prerelease
        required: false
        default: false
        type: boolean

permissions:
  contents: write

concurrency:
  group: release-packages-${{ github.ref_name }}
  cancel-in-progress: false

env:
  DOTNET_CLI_TELEMETRY_OPTOUT: 1
  DOTNET_NOLOGO: 1
  PYTHONUTF8: "1"

jobs:
  windows-matrix:
    name: Windows ${{ matrix.arch }} release bundle
    runs-on: ${{ matrix.runner }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - arch: x64
            runner: windows-latest
            rid: win-x64
            dotnet_platform: x64
            go_platform: windows/amd64
            electron_arch: x64
          - arch: arm64
            runner: windows-11-arm
            rid: win-arm64
            dotnet_platform: arm64
            go_platform: windows/arm64
            electron_arch: arm64

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup .NET
        uses: actions/setup-dotnet@v5
        with:
          dotnet-version: "10.0.x"

      - name: Setup Python
        uses: actions/setup-python@v6
        with:
          python-version: "3.13"

      - name: Setup Node
        uses: actions/setup-node@v6
        with:
          node-version: "24"
          cache: npm
          cache-dependency-path: |
            TranslationFiestaElectron/package-lock.json
            TranslationFiestaGo/frontend/package-lock.json

      - name: Setup Go
        uses: actions/setup-go@v6
        with:
          go-version: "1.26.x"
          cache-dependency-path: TranslationFiestaGo/go.sum

      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: "3.4"
          bundler-cache: false
          working-directory: TranslationFiestaRuby

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          flutter-version: 3.41.2

      - name: Prepare output folders
        shell: pwsh
        run: |
          $root = "$env:GITHUB_WORKSPACE\dist\release\windows-${{ matrix.arch }}"
          New-Item -ItemType Directory -Force -Path $root | Out-Null

      - name: Build .NET desktop apps
        shell: pwsh
        run: |
          $root = "$env:GITHUB_WORKSPACE\dist\release\windows-${{ matrix.arch }}"

          dotnet publish TranslationFiestaCSharp/TranslationFiestaCSharp.csproj `
            -c Release -r ${{ matrix.rid }} --self-contained true `
            -o "$root\TranslationFiestaCSharp"

          dotnet publish TranslationFiestaFSharp/TranslationFiestaFSharp.fsproj `
            -c Release -r ${{ matrix.rid }} --self-contained true `
            -o "$root\TranslationFiestaFSharp"

          dotnet publish TranslationFiesta.WinUI/TranslationFiesta.WinUI.csproj `
            -c Release -r ${{ matrix.rid }} --self-contained true `
            -p:Platform=${{ matrix.dotnet_platform }} -p:RuntimeIdentifier=${{ matrix.rid }} `
            -p:WindowsAppSDKSelfContained=true `
            -p:WindowsPackageType=None -p:AppxPackage=false -p:GenerateAppxPackageOnBuild=false `
            -o "$root\TranslationFiesta.WinUI"

      - name: Build TranslationFiestaElectron
        shell: pwsh
        run: |
          $root = "$env:GITHUB_WORKSPACE\dist\release\windows-${{ matrix.arch }}"

          Push-Location TranslationFiestaElectron
          npm ci
          npm run build
          npx electron-packager . TranslationFiestaElectron --platform=win32 --arch=${{ matrix.electron_arch }} --out "$root\TranslationFiestaElectron" --overwrite --prune=true
          Pop-Location

      - name: Build TranslationFiestaFlutter
        shell: pwsh
        run: |
          $root = "$env:GITHUB_WORKSPACE\dist\release\windows-${{ matrix.arch }}"

          flutter config --enable-windows-desktop
          $flutterBuildRoot = "$env:GITHUB_WORKSPACE\TranslationFiestaFlutter\build\windows"
          if (Test-Path $flutterBuildRoot) {
            Remove-Item $flutterBuildRoot -Recurse -Force
          }
          Push-Location TranslationFiestaFlutter
          flutter clean
          flutter pub get
          flutter build windows --release
          Pop-Location

          $target = "$root\TranslationFiestaFlutter"
          New-Item -ItemType Directory -Force -Path $target | Out-Null

          $candidate = "$env:GITHUB_WORKSPACE\TranslationFiestaFlutter\build\windows\${{ matrix.arch }}\runner\Release"
          if (!(Test-Path $candidate)) {
            $candidate = Get-ChildItem "$env:GITHUB_WORKSPACE\TranslationFiestaFlutter\build\windows" -Directory |
              ForEach-Object { Join-Path $_.FullName 'runner\\Release' } |
              Where-Object { Test-Path $_ } |
              Select-Object -First 1
          }

          if (-not $candidate) {
            throw "Unable to locate Flutter windows release output."
          }

          Copy-Item "$candidate\*" $target -Recurse -Force

      - name: Build TranslationFiestaGo (Wails)
        shell: pwsh
        run: |
          $root = "$env:GITHUB_WORKSPACE\dist\release\windows-${{ matrix.arch }}"
          go install github.com/wailsapp/wails/v2/cmd/wails@v2.11.0
          $env:PATH = "$env:PATH;$(go env GOPATH)\\bin"

          Push-Location TranslationFiestaGo
          wails build -platform ${{ matrix.go_platform }} -clean -o TranslationFiestaGo
          Pop-Location

          $target = "$root\TranslationFiestaGo"
          New-Item -ItemType Directory -Force -Path $target | Out-Null

          $buildRoot = "$env:GITHUB_WORKSPACE\TranslationFiestaGo\build\bin"
          if (!(Test-Path $buildRoot)) {
            throw "Unable to locate Wails Windows build output directory: $buildRoot"
          }

          Copy-Item "$buildRoot\*" $target -Recurse -Force

          $binary = "$target\TranslationFiestaGo.exe"
          if (!(Test-Path $binary)) {
            $binaryNoExt = "$target\TranslationFiestaGo"
            if (Test-Path $binaryNoExt) {
              Copy-Item $binaryNoExt $binary -Force
            } else {
              throw "Unable to locate Wails Windows binary in $buildRoot."
            }
          }

      - name: Build Python apps
        shell: pwsh
        run: |
          $root = "$env:GITHUB_WORKSPACE\dist\release\windows-${{ matrix.arch }}"
          $pythonOutRoot = "$env:GITHUB_WORKSPACE\TranslationFiestaPy\out"

          python -m pip install --upgrade pip
          pip install -r TranslationFiestaPy/requirements.lock
          pip install pyinstaller

          if (Test-Path $pythonOutRoot) {
            Remove-Item $pythonOutRoot -Recurse -Force
          }
          New-Item -ItemType Directory -Force -Path $pythonOutRoot | Out-Null

          Push-Location TranslationFiestaPy
          pyinstaller --noconfirm --clean --windowed --onedir --name TranslationFiestaPy --collect-submodules tkinterweb --collect-data tkinterweb --collect-submodules tkinterweb_tkhtml --collect-data tkinterweb_tkhtml --distpath "$pythonOutRoot\dist" --workpath "$pythonOutRoot\build" --specpath "$pythonOutRoot\spec" TranslationFiesta.py
          Pop-Location

          New-Item -ItemType Directory -Force -Path "$root\TranslationFiestaPy" | Out-Null
          Copy-Item "$pythonOutRoot\dist\TranslationFiestaPy\*" "$root\TranslationFiestaPy" -Recurse -Force

      - name: Build TranslationFiestaRuby
        shell: pwsh
        run: |
          $root = "$env:GITHUB_WORKSPACE\dist\release\windows-${{ matrix.arch }}"
          $target = "$root\TranslationFiestaRuby"
          New-Item -ItemType Directory -Force -Path $target | Out-Null

          Push-Location TranslationFiestaRuby
          gem update --system
          gem cleanup
          gem uninstall wxruby3 -a -x --ignore-dependencies || $true
          gem install rake --no-document
          bundle install --deployment --path vendor/bundle --jobs 4 --retry 3
          $rubyPrefix = (& ruby -e "require 'rbconfig'; print RbConfig::CONFIG['prefix']").Trim()
          Pop-Location

          $sourceRoot = "$env:GITHUB_WORKSPACE\TranslationFiestaRuby"
          $pathsToCopy = @('Gemfile', 'Gemfile.lock', 'translation_fiesta.gemspec', 'bin', 'lib', 'config', 'vendor')

          foreach ($path in $pathsToCopy) {
            Copy-Item (Join-Path $sourceRoot $path) (Join-Path $target $path) -Recurse -Force
          }

          $rubyPrefixPath = $rubyPrefix -replace '/', '\'
          if (!(Test-Path $rubyPrefixPath)) {
            throw "Ruby runtime path not found: $rubyPrefixPath"
          }

          $rubyRuntimeTarget = Join-Path $target 'ruby-runtime'
          New-Item -ItemType Directory -Force -Path $rubyRuntimeTarget | Out-Null
          Copy-Item (Join-Path $rubyPrefixPath '*') $rubyRuntimeTarget -Recurse -Force

          $bundleBat = Join-Path $rubyRuntimeTarget 'bin\bundle.bat'
          if (!(Test-Path $bundleBat)) {
            throw "Bundled Ruby runtime is missing bundle.bat at $bundleBat"
          }

          $libGmp = Get-ChildItem -Path $rubyRuntimeTarget -Recurse -Filter 'libgmp-10.dll' | Select-Object -First 1
          if (-not $libGmp) {
            throw "Bundled Ruby runtime is missing libgmp-10.dll"
          }

          $runPs1 = @(
            "Set-StrictMode -Version Latest"
            "`$ErrorActionPreference = 'Stop'"
            "Set-Location `$PSScriptRoot"
            "`$runtimeBin = Join-Path `$PSScriptRoot 'ruby-runtime\bin'"
            "`$env:PATH = ""`$runtimeBin;`$env:PATH"""
            "`$env:BUNDLE_GEMFILE = Join-Path `$PSScriptRoot 'Gemfile'"
            "`$env:BUNDLE_PATH = Join-Path `$PSScriptRoot 'vendor\bundle'"
            "& (Join-Path `$runtimeBin 'bundle.bat') exec ruby bin/translation_fiesta"
          ) -join [Environment]::NewLine
          Set-Content -Path "$target\run.ps1" -Value $runPs1

          $runCmd = @(
            "@echo off"
            "setlocal"
            "cd /d ""%~dp0"""
            "set ""RUNTIME_BIN=%~dp0ruby-runtime\bin"""
            "set ""PATH=%RUNTIME_BIN%;%PATH%"""
            "set ""BUNDLE_GEMFILE=%~dp0Gemfile"""
            "set ""BUNDLE_PATH=%~dp0vendor\bundle"""
            "call ""%RUNTIME_BIN%\bundle.bat"" exec ruby bin\translation_fiesta"
          ) -join [Environment]::NewLine
          Set-Content -Path "$target\run.cmd" -Value $runCmd

      - name: Create Windows portable launchers
        shell: pwsh
        run: |
          $root = "$env:GITHUB_WORKSPACE\dist\release\windows-${{ matrix.arch }}"
          & "$env:GITHUB_WORKSPACE\scripts\create_windows_launchers.ps1" -Root $root

      - name: Verify expected Windows artifacts
        shell: pwsh
        run: |
          $root = "$env:GITHUB_WORKSPACE\dist\release\windows-${{ matrix.arch }}"
          $requiredDirs = @(
            'TranslationFiestaCSharp',
            'TranslationFiestaFSharp',
            'TranslationFiesta.WinUI',
            'TranslationFiestaElectron',
            'TranslationFiestaFlutter',
            'TranslationFiestaGo',
            'TranslationFiestaPy',
            'TranslationFiestaRuby'
          )

          foreach ($dir in $requiredDirs) {
            if (!(Test-Path (Join-Path $root $dir))) {
              throw "Missing build output directory: $dir"
            }
            if (!(Test-Path (Join-Path $root "$dir\run.cmd"))) {
              throw "Missing launcher script: $dir\\run.cmd"
            }
            if (!(Test-Path (Join-Path $root "$dir\run.ps1"))) {
              throw "Missing launcher script: $dir\\run.ps1"
            }
          }

          $bundleLaunchers = @(
            "$root\launch.cmd",
            "$root\launch.ps1"
          )

          foreach ($launcherPath in $bundleLaunchers) {
            if (!(Test-Path $launcherPath)) {
              throw "Missing bundle launcher: $launcherPath"
            }
          }

          $launcherChecks = @(
            "$root\TranslationFiesta.WinUI\TranslationFiesta.WinUI.exe",
            "$root\TranslationFiestaGo\TranslationFiestaGo.exe",
            "$root\TranslationFiestaPy\TranslationFiestaPy.exe"
          )

          foreach ($launcher in $launcherChecks) {
            if (!(Test-Path $launcher)) {
              throw "Missing expected launcher binary: $launcher"
            }
          }

          $rubyExpected = @(
            "$root\TranslationFiestaRuby\run.ps1",
            "$root\TranslationFiestaRuby\run.cmd",
            "$root\TranslationFiestaRuby\ruby-runtime\bin\ruby.exe",
            "$root\TranslationFiestaRuby\ruby-runtime\bin\libgmp-10.dll"
          )

          foreach ($path in $rubyExpected) {
            if (!(Test-Path $path)) {
              throw "Missing expected Ruby payload: $path"
            }
          }

      - name: Package Windows release artifacts
        shell: pwsh
        run: |
          $sourceRoot = "$env:GITHUB_WORKSPACE\dist\release\windows-${{ matrix.arch }}"
          $zipRoot = "$env:GITHUB_WORKSPACE\dist\release\windows-${{ matrix.arch }}-zips"
          New-Item -ItemType Directory -Force -Path $zipRoot | Out-Null

          Get-ChildItem -Path $sourceRoot -Directory | Sort-Object Name | ForEach-Object {
            $appName = $_.Name
            $zipName = "$appName-windows-${{ matrix.arch }}.zip"
            $zipPath = Join-Path $zipRoot $zipName

            New-Item -ItemType Directory -Force -Path (Join-Path $_.FullName 'data') | Out-Null
            if (Test-Path $zipPath) { Remove-Item $zipPath -Force }
            Compress-Archive -Path (Join-Path $_.FullName '*') -DestinationPath $zipPath -CompressionLevel Optimal

            $hash = (Get-FileHash -Path $zipPath -Algorithm SHA256).Hash.ToLower()
            "$hash  $zipName" | Set-Content "$zipPath.sha256"
          }

          $manifestPath = Join-Path $zipRoot 'SHA256SUMS-windows-${{ matrix.arch }}.txt'
          Get-ChildItem -Path $zipRoot -Filter '*.sha256' | Sort-Object Name | Get-Content | Set-Content $manifestPath

          $archives = Get-ChildItem -Path $zipRoot -Filter '*.zip'
          if ($archives.Count -eq 0) {
            throw "No Windows portable zip archives were produced."
          }

          $checksumFiles = Get-ChildItem -Path $zipRoot -Filter '*.sha256'
          if ($checksumFiles.Count -ne $archives.Count) {
            throw "Checksum count mismatch: found $($checksumFiles.Count) checksum files for $($archives.Count) archives."
          }

          if (!(Test-Path $manifestPath)) {
            throw "Missing Windows checksum manifest: $manifestPath"
          }

          $disallowed = Get-ChildItem -Path $zipRoot -File | Where-Object { $_.Extension -in '.msi', '.msix', '.dmg', '.pkg', '.appimage' }
          if ($disallowed.Count -gt 0) {
            $disallowed | ForEach-Object { Write-Error "Disallowed installer artifact found: $($_.FullName)" }
            throw "Installer artifacts are not allowed in portable releases."
          }

      - name: Upload Windows release artifacts
        uses: actions/upload-artifact@v6
        with:
          name: release-windows-${{ matrix.arch }}
          path: dist/release/windows-${{ matrix.arch }}-zips/*
          if-no-files-found: error

  linux-matrix:
    name: Linux ${{ matrix.arch }} release bundle
    runs-on: ${{ matrix.runner }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - arch: x64
            runner: ubuntu-24.04
            go_platform: linux/amd64
            electron_arch: x64
          - arch: arm64
            runner: ubuntu-24.04-arm
            go_platform: linux/arm64
            electron_arch: arm64

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Python
        uses: actions/setup-python@v6
        with:
          python-version: "3.13"

      - name: Setup Node
        uses: actions/setup-node@v6
        with:
          node-version: "24"
          cache: npm
          cache-dependency-path: |
            TranslationFiestaElectron/package-lock.json
            TranslationFiestaGo/frontend/package-lock.json

      - name: Setup Go
        uses: actions/setup-go@v6
        with:
          go-version: "1.26.x"
          cache-dependency-path: TranslationFiestaGo/go.sum

      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: "3.4"
          bundler-cache: false
          working-directory: TranslationFiestaRuby

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          flutter-version: 3.41.2

      - name: Install Linux desktop build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            clang \
            cmake \
            ninja-build \
            pkg-config \
            libgtk-3-dev \
            liblzma-dev \
            libwebkit2gtk-4.1-dev \
            libsoup-3.0-dev

      - name: Prepare output folders
        run: |
          mkdir -p "dist/release/linux-${{ matrix.arch }}"

      - name: Build TranslationFiestaElectron
        run: |
          set -euo pipefail
          root="$GITHUB_WORKSPACE/dist/release/linux-${{ matrix.arch }}"

          cd TranslationFiestaElectron
          npm ci
          npm run build
          npx electron-packager . TranslationFiestaElectron --platform=linux --arch=${{ matrix.electron_arch }} --out "$root/TranslationFiestaElectron" --overwrite --prune=true

      - name: Build TranslationFiestaFlutter
        run: |
          set -euo pipefail
          root="$GITHUB_WORKSPACE/dist/release/linux-${{ matrix.arch }}"

          flutter config --enable-linux-desktop
          cd TranslationFiestaFlutter
          flutter pub get
          flutter build linux --release

          target="$root/TranslationFiestaFlutter"
          mkdir -p "$target"

          candidate="$GITHUB_WORKSPACE/TranslationFiestaFlutter/build/linux/${{ matrix.arch }}/release/bundle"
          if [[ ! -d "$candidate" ]]; then
            candidate="$(find "$GITHUB_WORKSPACE/TranslationFiestaFlutter/build/linux" -type d -path '*/release/bundle' | head -n1)"
          fi

          if [[ -z "$candidate" || ! -d "$candidate" ]]; then
            echo "Unable to locate Flutter linux release bundle." >&2
            exit 1
          fi

          cp -R "$candidate"/* "$target/"

      - name: Build TranslationFiestaGo (Wails)
        run: |
          set -euo pipefail
          root="$GITHUB_WORKSPACE/dist/release/linux-${{ matrix.arch }}"

          go install github.com/wailsapp/wails/v2/cmd/wails@v2.11.0
          export PATH="$PATH:$(go env GOPATH)/bin"

          cd TranslationFiestaGo
          wails build -platform "${{ matrix.go_platform }}" -tags webkit2_41 -clean -o TranslationFiestaGo

          mkdir -p "$root/TranslationFiestaGo"
          build_root="$GITHUB_WORKSPACE/TranslationFiestaGo/build/bin"
          if [[ ! -d "$build_root" ]]; then
            echo "Unable to locate Wails Linux build output directory: $build_root" >&2
            exit 1
          fi
          cp -R "$build_root"/. "$root/TranslationFiestaGo/"
          if [[ ! -f "$root/TranslationFiestaGo/TranslationFiestaGo" ]]; then
            binary="$(find "$root/TranslationFiestaGo" -maxdepth 1 -type f -name 'TranslationFiestaGo*' | head -n1)"
            if [[ -z "$binary" ]]; then
              echo "Unable to locate Wails Linux binary in $build_root." >&2
              exit 1
            fi
            cp "$binary" "$root/TranslationFiestaGo/TranslationFiestaGo"
          fi

      - name: Build Python apps
        run: |
          set -euo pipefail
          root="$GITHUB_WORKSPACE/dist/release/linux-${{ matrix.arch }}"
          python_out_root="$GITHUB_WORKSPACE/TranslationFiestaPy/out"

          python -m pip install --upgrade pip
          pip install -r TranslationFiestaPy/requirements.lock
          pip install pyinstaller

          rm -rf "$python_out_root"
          mkdir -p "$python_out_root"

          cd TranslationFiestaPy
          pyinstaller --noconfirm --clean --onedir --name TranslationFiestaPy --collect-submodules tkinterweb --collect-data tkinterweb --collect-submodules tkinterweb_tkhtml --collect-data tkinterweb_tkhtml --distpath "$python_out_root/dist" --workpath "$python_out_root/build" --specpath "$python_out_root/spec" TranslationFiesta.py

          mkdir -p "$root/TranslationFiestaPy"
          cp -R "$python_out_root/dist/TranslationFiestaPy/"* "$root/TranslationFiestaPy/"

      - name: Build TranslationFiestaRuby runtime bundle
        run: |
          set -euo pipefail
          root="$GITHUB_WORKSPACE/dist/release/linux-${{ matrix.arch }}"
          bundle_dir="$root/TranslationFiestaRuby"

          cd TranslationFiestaRuby
          gem update --system
          gem cleanup
          gem uninstall wxruby3 -a -x --ignore-dependencies || true
          gem install rake --no-document
          bundle install --deployment --path vendor/bundle --jobs 4 --retry 3
          ruby_prefix="$(ruby -e "require 'rbconfig'; print RbConfig::CONFIG['prefix']")"

          mkdir -p "$bundle_dir"
          cp -R Gemfile Gemfile.lock translation_fiesta.gemspec bin lib config vendor "$bundle_dir/"
          cp -R "$ruby_prefix" "$bundle_dir/ruby-runtime"
          printf '%s\n' \
            '#!/usr/bin/env bash' \
            'set -euo pipefail' \
            'cd "$(dirname "$0")"' \
            'runtime_bin="$PWD/ruby-runtime/bin"' \
            'export PATH="$runtime_bin:$PATH"' \
            'export BUNDLE_GEMFILE="$PWD/Gemfile"' \
            'export BUNDLE_PATH="$PWD/vendor/bundle"' \
            'exec "$runtime_bin/ruby" bin/translation_fiesta' > "$bundle_dir/run.sh"
          chmod +x "$bundle_dir/run.sh"

      - name: Create Linux portable launchers
        run: |
          set -euo pipefail
          chmod +x scripts/create_unix_launchers.sh
          scripts/create_unix_launchers.sh --root "dist/release/linux-${{ matrix.arch }}" --platform linux

      - name: Verify expected Linux artifacts
        run: |
          set -euo pipefail
          root="$GITHUB_WORKSPACE/dist/release/linux-${{ matrix.arch }}"

          for app in TranslationFiestaElectron TranslationFiestaFlutter TranslationFiestaGo TranslationFiestaPy TranslationFiestaRuby; do
            [[ -d "$root/$app" ]] || { echo "Missing build output directory: $app" >&2; exit 1; }
            [[ -f "$root/$app/run.sh" ]] || { echo "Missing launcher script: $root/$app/run.sh" >&2; exit 1; }
          done

          [[ -f "$root/launch.sh" ]] || { echo "Missing bundle launcher: $root/launch.sh" >&2; exit 1; }

          for ruby_path in \
            "$root/TranslationFiestaRuby/run.sh" \
            "$root/TranslationFiestaRuby/ruby-runtime/bin/ruby"; do
            [[ -e "$ruby_path" ]] || { echo "Missing expected Ruby payload: $ruby_path" >&2; exit 1; }
          done

      - name: Package Linux release artifacts
        run: |
          set -euo pipefail
          source_root="$GITHUB_WORKSPACE/dist/release/linux-${{ matrix.arch }}"
          archive_root="$GITHUB_WORKSPACE/dist/release/linux-${{ matrix.arch }}-archives"

          mkdir -p "$archive_root"
          for app_dir in "$source_root"/*; do
            [[ -d "$app_dir" ]] || continue
            app_name="$(basename "$app_dir")"
            archive_name="${app_name}-linux-${{ matrix.arch }}.tar.gz"
            archive_path="$archive_root/$archive_name"

            mkdir -p "$app_dir/data"

            rm -f "$archive_path"
            (
              cd "$source_root"
              tar -czf "$archive_path" "$app_name"
            )
            hash="$(sha256sum "$archive_path" | cut -d' ' -f1)"
            echo "$hash  $archive_name" > "$archive_path.sha256"
          done

          cat "$archive_root"/*.sha256 | sort > "$archive_root/SHA256SUMS-linux-${{ matrix.arch }}.txt"

          shopt -s nullglob
          archives=("$archive_root"/*.tar.gz)
          if (( ${#archives[@]} == 0 )); then
            echo "No Linux portable archives were produced." >&2
            exit 1
          fi

          checksum_files=("$archive_root"/*.sha256)
          if (( ${#checksum_files[@]} != ${#archives[@]} )); then
            echo "Checksum count mismatch: found ${#checksum_files[@]} checksum files for ${#archives[@]} archives." >&2
            exit 1
          fi

          [[ -f "$archive_root/SHA256SUMS-linux-${{ matrix.arch }}.txt" ]] || {
            echo "Missing Linux checksum manifest." >&2
            exit 1
          }

          disallowed=("$archive_root"/*.msi "$archive_root"/*.msix "$archive_root"/*.dmg "$archive_root"/*.pkg "$archive_root"/*.appimage)
          for artifact in "${disallowed[@]}"; do
            if [[ -e "$artifact" ]]; then
              echo "Disallowed installer artifact found: $artifact" >&2
              exit 1
            fi
          done

      - name: Upload Linux release artifacts
        uses: actions/upload-artifact@v6
        with:
          name: release-linux-${{ matrix.arch }}
          path: dist/release/linux-${{ matrix.arch }}-archives/*
          if-no-files-found: error

  macos-matrix:
    name: macOS ${{ matrix.arch }} release bundle
    runs-on: ${{ matrix.runner }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - arch: x64
            runner: macos-15-intel
            go_platform: darwin/amd64
            electron_arch: x64
          - arch: arm64
            runner: macos-15
            go_platform: darwin/arm64
            electron_arch: arm64

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Python
        uses: actions/setup-python@v6
        with:
          python-version: "3.13"

      - name: Setup Node
        uses: actions/setup-node@v6
        with:
          node-version: "24"
          cache: npm
          cache-dependency-path: |
            TranslationFiestaElectron/package-lock.json
            TranslationFiestaGo/frontend/package-lock.json

      - name: Setup Go
        uses: actions/setup-go@v6
        with:
          go-version: "1.26.x"
          cache-dependency-path: TranslationFiestaGo/go.sum

      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: "3.4"
          bundler-cache: false
          working-directory: TranslationFiestaRuby

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          flutter-version: 3.41.2

      - name: Prepare output folders
        run: |
          mkdir -p "dist/release/macos-${{ matrix.arch }}"

      - name: Build TranslationFiestaSwift
        run: |
          set -euo pipefail
          root="$GITHUB_WORKSPACE/dist/release/macos-${{ matrix.arch }}"

          cd TranslationFiestaSwift
          swift build -c release

          mkdir -p "$root/TranslationFiestaSwift"
          cp "$GITHUB_WORKSPACE/TranslationFiestaSwift/.build/release/TranslationFiestaSwift" "$root/TranslationFiestaSwift/TranslationFiestaSwift"
          chmod +x "$root/TranslationFiestaSwift/TranslationFiestaSwift"

      - name: Build TranslationFiestaElectron
        run: |
          set -euo pipefail
          root="$GITHUB_WORKSPACE/dist/release/macos-${{ matrix.arch }}"

          cd TranslationFiestaElectron
          npm ci
          npm run build
          npx electron-packager . TranslationFiestaElectron --platform=darwin --arch=${{ matrix.electron_arch }} --out "$root/TranslationFiestaElectron" --overwrite --prune=true

      - name: Build TranslationFiestaFlutter
        run: |
          set -euo pipefail
          root="$GITHUB_WORKSPACE/dist/release/macos-${{ matrix.arch }}"

          flutter config --enable-macos-desktop
          cd TranslationFiestaFlutter
          flutter pub get
          flutter build macos --release

          mkdir -p "$root/TranslationFiestaFlutter"
          app_bundle="$(find "$GITHUB_WORKSPACE/TranslationFiestaFlutter/build/macos/Build/Products/Release" -maxdepth 1 -type d -name '*.app' | head -n1)"
          if [[ -z "$app_bundle" ]]; then
            echo "Unable to locate Flutter macOS app bundle." >&2
            exit 1
          fi
          cp -R "$app_bundle" "$root/TranslationFiestaFlutter/"

      - name: Build TranslationFiestaGo (Wails)
        run: |
          set -euo pipefail
          root="$GITHUB_WORKSPACE/dist/release/macos-${{ matrix.arch }}"

          go install github.com/wailsapp/wails/v2/cmd/wails@v2.11.0
          export PATH="$PATH:$(go env GOPATH)/bin"

          cd TranslationFiestaGo
          wails build -platform "${{ matrix.go_platform }}" -clean -o TranslationFiestaGo

          mkdir -p "$root/TranslationFiestaGo"
          build_root="$GITHUB_WORKSPACE/TranslationFiestaGo/build/bin"
          if [[ ! -d "$build_root" ]]; then
            echo "Unable to locate Wails macOS build output directory: $build_root" >&2
            exit 1
          fi
          cp -R "$build_root"/. "$root/TranslationFiestaGo/"

          if [[ ! -d "$root/TranslationFiestaGo/TranslationFiestaGo.app" && ! -f "$root/TranslationFiestaGo/TranslationFiestaGo" ]]; then
            binary="$(find "$root/TranslationFiestaGo" -maxdepth 1 -type f -name 'TranslationFiestaGo*' | head -n1)"
            if [[ -n "$binary" ]]; then
              cp "$binary" "$root/TranslationFiestaGo/TranslationFiestaGo"
            fi
          fi

      - name: Build Python apps
        run: |
          set -euo pipefail
          root="$GITHUB_WORKSPACE/dist/release/macos-${{ matrix.arch }}"
          python_out_root="$GITHUB_WORKSPACE/TranslationFiestaPy/out"

          python -m pip install --upgrade pip
          pip install -r TranslationFiestaPy/requirements.lock
          pip install pyinstaller

          rm -rf "$python_out_root"
          mkdir -p "$python_out_root"

          cd TranslationFiestaPy
          pyinstaller --noconfirm --clean --onedir --name TranslationFiestaPy --collect-submodules tkinterweb --collect-data tkinterweb --collect-submodules tkinterweb_tkhtml --collect-data tkinterweb_tkhtml --distpath "$python_out_root/dist" --workpath "$python_out_root/build" --specpath "$python_out_root/spec" TranslationFiesta.py

          mkdir -p "$root/TranslationFiestaPy"
          cp -R "$python_out_root/dist/TranslationFiestaPy/"* "$root/TranslationFiestaPy/"

      - name: Build TranslationFiestaRuby runtime bundle
        run: |
          set -euo pipefail
          root="$GITHUB_WORKSPACE/dist/release/macos-${{ matrix.arch }}"
          bundle_dir="$root/TranslationFiestaRuby"

          cd TranslationFiestaRuby
          gem update --system
          gem cleanup
          gem uninstall wxruby3 -a -x --ignore-dependencies || true
          gem install rake --no-document
          bundle install --deployment --path vendor/bundle --jobs 4 --retry 3
          ruby_prefix="$(ruby -e "require 'rbconfig'; print RbConfig::CONFIG['prefix']")"

          mkdir -p "$bundle_dir"
          cp -R Gemfile Gemfile.lock translation_fiesta.gemspec bin lib config vendor "$bundle_dir/"
          cp -R "$ruby_prefix" "$bundle_dir/ruby-runtime"
          printf '%s\n' \
            '#!/usr/bin/env bash' \
            'set -euo pipefail' \
            'cd "$(dirname "$0")"' \
            'runtime_bin="$PWD/ruby-runtime/bin"' \
            'export PATH="$runtime_bin:$PATH"' \
            'export BUNDLE_GEMFILE="$PWD/Gemfile"' \
            'export BUNDLE_PATH="$PWD/vendor/bundle"' \
            'exec "$runtime_bin/ruby" bin/translation_fiesta' > "$bundle_dir/run.command"
          chmod +x "$bundle_dir/run.command"

      - name: Create macOS portable launchers
        run: |
          set -euo pipefail
          chmod +x scripts/create_unix_launchers.sh
          scripts/create_unix_launchers.sh --root "dist/release/macos-${{ matrix.arch }}" --platform macos

      - name: Verify expected macOS artifacts
        run: |
          set -euo pipefail
          root="$GITHUB_WORKSPACE/dist/release/macos-${{ matrix.arch }}"

          for app in TranslationFiestaSwift TranslationFiestaElectron TranslationFiestaFlutter TranslationFiestaGo TranslationFiestaPy TranslationFiestaRuby; do
            [[ -d "$root/$app" ]] || { echo "Missing build output directory: $app" >&2; exit 1; }
            [[ -f "$root/$app/run.command" ]] || { echo "Missing launcher script: $root/$app/run.command" >&2; exit 1; }
          done

          [[ -f "$root/launch.command" ]] || { echo "Missing bundle launcher: $root/launch.command" >&2; exit 1; }

          for ruby_path in \
            "$root/TranslationFiestaRuby/run.command" \
            "$root/TranslationFiestaRuby/ruby-runtime/bin/ruby"; do
            [[ -e "$ruby_path" ]] || { echo "Missing expected Ruby payload: $ruby_path" >&2; exit 1; }
          done

      - name: Package macOS release artifacts
        run: |
          set -euo pipefail
          source_root="$GITHUB_WORKSPACE/dist/release/macos-${{ matrix.arch }}"
          zip_root="$GITHUB_WORKSPACE/dist/release/macos-${{ matrix.arch }}-zips"

          mkdir -p "$zip_root"
          for app_dir in "$source_root"/*; do
            [[ -d "$app_dir" ]] || continue
            app_name="$(basename "$app_dir")"
            zip_path="$zip_root/${app_name}-macos-${{ matrix.arch }}.zip"

            mkdir -p "$app_dir/data"

            rm -f "$zip_path"
            ditto -c -k --sequesterRsrc --keepParent "$app_dir" "$zip_path"
            zip_name="$(basename "$zip_path")"
            hash="$(shasum -a 256 "$zip_path" | cut -d' ' -f1)"
            echo "$hash  $zip_name" > "$zip_path.sha256"
          done

          cat "$zip_root"/*.sha256 | sort > "$zip_root/SHA256SUMS-macos-${{ matrix.arch }}.txt"

          shopt -s nullglob
          archives=("$zip_root"/*.zip)
          if (( ${#archives[@]} == 0 )); then
            echo "No macOS portable zip archives were produced." >&2
            exit 1
          fi

          checksum_files=("$zip_root"/*.sha256)
          if (( ${#checksum_files[@]} != ${#archives[@]} )); then
            echo "Checksum count mismatch: found ${#checksum_files[@]} checksum files for ${#archives[@]} archives." >&2
            exit 1
          fi

          [[ -f "$zip_root/SHA256SUMS-macos-${{ matrix.arch }}.txt" ]] || {
            echo "Missing macOS checksum manifest." >&2
            exit 1
          }

          disallowed=("$zip_root"/*.msi "$zip_root"/*.msix "$zip_root"/*.dmg "$zip_root"/*.pkg "$zip_root"/*.appimage)
          for artifact in "${disallowed[@]}"; do
            if [[ -e "$artifact" ]]; then
              echo "Disallowed installer artifact found: $artifact" >&2
              exit 1
            fi
          done

      - name: Upload macOS release artifacts
        uses: actions/upload-artifact@v6
        with:
          name: release-macos-${{ matrix.arch }}
          path: dist/release/macos-${{ matrix.arch }}-zips/*
          if-no-files-found: error

  publish-release-assets:
    name: Publish assets to GitHub Release
    if: ${{ github.event_name == 'release' || github.event_name == 'workflow_dispatch' }}
    runs-on: ubuntu-24.04
    needs:
      - windows-matrix
      - linux-matrix
      - macos-matrix

    steps:
      - name: Download all packaged artifacts
        uses: actions/download-artifact@v5
        with:
          pattern: release-*
          merge-multiple: true
          path: release-assets

      - name: Build aggregate checksum manifest
        shell: bash
        run: |
          set -euo pipefail
          shopt -s nullglob
          checksum_files=(release-assets/*.sha256)
          if (( ${#checksum_files[@]} == 0 )); then
            echo "No checksum files were found in release-assets/." >&2
            exit 1
          fi

          cat "${checksum_files[@]}" | sort > release-assets/SHA256SUMS-all.txt

      - name: Resolve release metadata
        id: release-meta
        shell: bash
        run: |
          set -euo pipefail

          if [[ "${GITHUB_EVENT_NAME}" == "release" ]]; then
            tag="${{ github.event.release.tag_name }}"
            name="${{ github.event.release.name }}"
            prerelease="${{ github.event.release.prerelease }}"
          else
            tag="${{ inputs.release_tag }}"
            name="${{ inputs.release_name }}"
            prerelease="${{ inputs.prerelease }}"
          fi

          if [[ -z "$tag" ]]; then
            echo "Release tag is required." >&2
            exit 1
          fi

          if [[ -z "$name" ]]; then
            name="VibeTranslate Release ${tag}"
          fi

          {
            echo "tag=$tag"
            echo "name=$name"
            echo "prerelease=$prerelease"
          } >> "$GITHUB_OUTPUT"

      - name: Publish assets
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.release-meta.outputs.tag }}
          name: ${{ steps.release-meta.outputs.name }}
          prerelease: ${{ steps.release-meta.outputs.prerelease }}
          files: release-assets/*
          fail_on_unmatched_files: true
